---
title: "Trade Statistics Report"
author: "Vanuatu National Statistics Office"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: '2'
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r preparation, include=FALSE}

# Load the required libraries
library(knitr) # Nice tables
library(kableExtra) # Extra nice tables
library(dplyr) # Manipulating data
library(openxlsx) # Reading and editing excel formatted files

# Load the general R functions
source("functions.R")
```

## Importing data files

```{r import and process data}

# Read in the raw trade data
# Note that spaces in column names have been automatically replaced with "."s
tradeStatsFile <- file.path("..", "data", "secure", "OPN_PROC_ASY_RawDataAndReferenceTables_31-01-20.xlsx")
tradeStats <- read.xlsx(tradeStatsFile, sheet=1, skipEmptyRows=TRUE)

# Remove the repeated header row from the trade statistics data
tradeStats <- tradeStats[tradeStats$Office != "Office", ]

# Convert the CP4 to a factor
tradeStats$CP4 <- as.factor(tradeStats$CP4)

# Convert the statistical value to numeric
tradeStats$Stat..Value <- as.numeric(tradeStats$Stat..Value)
```


## Trade Balance
```{r calculate balance of trade statistics}
tradeBalance <- tradeStats %>%
  #group_by(Type) %>%
  summarise(
            "Export" = sum(Stat..Value[CP4==1000]),
            "Re-Export" = sum(Stat..Value[CP4==3071]),
            "Total Export" = sum(Stat..Value[CP4==1000])+sum(Stat..Value[CP4==3071]),
            "Imports CIF" = sum(Stat..Value[CP4==4000]) + sum(Stat..Value[CP4==4071])+ sum(Stat..Value[CP4==7100]),
            "Trade Balance" = (sum(Stat..Value[CP4==1000])+sum(Stat..Value[CP4==3071])) - (sum(Stat..Value[CP4==4000]) + sum(Stat..Value[CP4==4071])+ sum(Stat..Value[CP4==7100])
            ))

prettyTable(tradeBalance)

```

```{r calculate balance of trade statistics with base R, eval=FALSE, echo=FALSE}

# Calculate the balance of trade statistics - note that this remove a bit of redundancy
exports <- sum(tradeStats[tradeStats$CP4 == 1000, "Stat..Value"], na.rm=TRUE) # Added na.rm in case NAs introduced at later date
reExports <- sum(tradeStats[tradeStats$CP4 == 3071, "Stat..Value"], na.rm=TRUE)
totalExports <- exports + reExports
imports <- sum(tradeStats[tradeStats$CP4 %in% c(4000, 4071, 7100), "Stat..Value"], na.rm=TRUE)
balance <- totalExports - imports

# Insert values into table
tradeBalance <- data.frame("Export"=exports, "Re-Export"=reExports, "Total Export"=totalExports, "Imports CIF"=imports, "Trade Balance"=balance)

prettyTable(tradeBalance)
```

```{r insert balance of trade statistics into final formatted table}

# Note current year and month of data
fileNameParts <- strsplit(tradeStatsFile, split="_")[[1]]
date <- as.Date(strsplit(fileNameParts[length(fileNameParts)], split="\\.")[[1]][1], format="%d-%m-%y")
month <- format(date, "%B")
year <- format(date, "%Y")

# Note the excel workbook containing the final formmatted tables
finalWorkbookFileName <- file.path("..", "outputs", "SEC_FINAL_MAN_FinalTradeStatisticsTables_31-01-20.xlsx")

## Updating the Annual and Monthly sub tables
# Extract the balance of trade data and extract sub tables
balanceOfTradeSubTables <- extractHistoricBalanceOfTradeStatistics(finalWorkbookFileName)

# Update the sub tables for the balance of trade data
balanceOfTradeSubTables <- updateBalanceOfTradeSubTables(balanceOfTradeSubTables, month, year, tradeBalance/1000000)

## Editing the final formatted tables
updatedFinalFormattedBalanceOfTradeTable(finalWorkbookFileName, balanceOfTradeSubTables)
```




