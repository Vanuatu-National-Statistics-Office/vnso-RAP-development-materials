---
title: "Trade Statistics Report"
author: "Vanuatu National Statistics Office"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: '2'
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r preparation, include=FALSE}

# Load the required libraries
library(knitr) # Nice tables
library(kableExtra) # Extra nice tables
library(dplyr) # Manipulating data
library(openxlsx) # Reading and editing excel formatted files

# Load the general R functions
source("functions.R")
```

## Importing data files

```{r import and process data}

# Read in the raw trade data
# Note that spaces in column names have been automatically replaced with "."s
tradeStatsFile <- file.path("..", "data", "secure", "SEC_PROC_ASY_RawDataAndReferenceTables_31-01-20.xlsx")
tradeStats <- read.xlsx(tradeStatsFile, sheet=1, skipEmptyRows=TRUE)

# Remove the repeated header row from the trade statistics data
tradeStats <- tradeStats[tradeStats$Office != "Office", ]

# Remove duplicated rows from the trade statistics data
duplicatedRows <- duplicated(tradeStats) #investigate for duplicates
tradeStatsNoDup <- tradeStats[duplicatedRows == FALSE, ]

# Convert the CP4 to a factor
tradeStatsNoDup$CP4 <- as.factor(tradeStats$CP4)

# Convert the statistical value to numeric
tradeStatsNoDup$Stat..Value <- as.numeric(tradeStats$Stat..Value)

# Convert excel figures to dates
tradeStatsNoDup$Reg..Date <- as.Date(as.numeric(tradeStats$Reg..Date), origin="1899-12-30") # For numeric dates excel sets origin to December 30, 1899 (https://stackoverflow.com/questions/43230470/how-to-convert-excel-date-format-to-proper-date-in-r)

# Create subset for Export and Import commodities 
tradeStatsCommodities <- tradeStatsNoDup[tradeStatsNoDup$CP4 %in% c(1000, 3071, 4000, 4071, 7100), ]

# Exclude banknotes from exports
tradeStatsNoBanknotes <- tradeStatsCommodities[tradeStatsCommodities$HS.Code != "49070010", ]

# Extract the 6, 4, and 2 digit HS codes into separate columns
tradeStatsNoBanknotes$HS.Code_6 <- extractCodeSubset(tradeStatsNoBanknotes$HS.Code, nDigits=6)
tradeStatsNoBanknotes$HS.Code_4 <- extractCodeSubset(tradeStatsNoBanknotes$HS.Code, nDigits=4)
tradeStatsNoBanknotes$HS.Code_2 <- extractCodeSubset(tradeStatsNoBanknotes$HS.Code, nDigits=2)

# Extract the 3 and 1 digit SITC codes into separate columns
tradeStatsNoBanknotes$SITC_3 <- extractCodeSubset(tradeStatsNoBanknotes$SITC, nDigits=3)
tradeStatsNoBanknotes$SITC_1 <- extractCodeSubset(tradeStatsNoBanknotes$SITC, nDigits=1)

# Create new columns for dates
tradeStatsNoBanknotes$Year<- format(tradeStatsNoBanknotes$Reg..Date, format= "%Y")
tradeStatsNoBanknotes$Month<- format(tradeStatsNoBanknotes$Reg..Date, format= "%B")
tradeStatsNoBanknotes$Day<- format(tradeStatsNoBanknotes$Reg..Date, format= "%d")

# Create new columns for SITC codes
tradeStatsNoBanknotes$SITC1<- substr(tradeStatsNoBanknotes$SITC, start=1, stop=1)
tradeStatsNoBanknotes$SITC3<- substr(tradeStatsNoBanknotes$SITC, start=1, stop=3)

# Quality check indicators (Wgt..Net and Stat..Value) 
tradeStatsNoBanknotes$Wgt..Net <- as.numeric(tradeStatsNoBanknotes$Wgt..Net) # Convert the net weight to numeric
tradeStatsNoBanknotes$PricePerUnit<- tradeStatsNoBanknotes$Stat..Value/tradeStatsNoBanknotes$Wgt..Net # Create new column 
tradeStatsCommoditiesSorted<- tradeStatsNoBanknotes[order(-tradeStatsNoBanknotes$Stat..Value), ] # Sort the stats value in descending order (this isn't working)

# Store principle exports and imports 


# Merge classifications 
tradeStatsFileMergeTransport <- file.path("..", "data", "open", "OPN_FINAL_ASY_ModeOfTransportClassifications_31-01-20.xlsx") # Mode of Transport
modeOfTransport <- read.xlsx(tradeStatsFileMergeTransport, sheet=1, skipEmptyRows=TRUE)
mergedModeOfTransport<- merge(modeOfTransport, tradeStatsCommoditiesSorted, by= "Office")

tradeStatsFileMergeHSCode <- file.path("..", "data", "open", "OPN_FINAL_ASY_HSCodeClassifications_31-01-20.xlsx") # HS codes
hsDescription <- read.xlsx(tradeStatsFileMergeHSCode, sheet=1, skipEmptyRows=TRUE)
mergedHSCode<- merge(hsDescription, mergedModeOfTransport, by= "HS.Code_2")

tradeStatsFileMergeCountryDes <- file.path("..", "data", "open", "OPN_FINAL_ASY_CountryDescriptionClassifications_31-01-20.xlsx") # Country of origin
countryDescritpion <- read.xlsx(tradeStatsFileMergeCountryDes, sheet=1, skipEmptyRows=TRUE)
mergedCountryOrigin<- merge(countryDescritpion, mergedHSCode, by= "CO")

tradeStatsFileMergeSITCCode <- file.path("..", "data", "open", "OPN_FINAL_ASY_SITCCodeClassifications_31-01-20.xlsx") # Country of origin
sitcDescription <- read.xlsx(tradeStatsFileMergeSITCCode, sheet=1, skipEmptyRows=TRUE)
mergedSITCDescription<- merge(sitcDescription, mergedCountryOrigin, by= "SITC1")

tradeStatsFileMergePrincipleCommodities <- file.path("..", "data", "open", "OPN_FINAL_ASY_PrincipleCommoditiesClassifications_31-01-20.xlsx") # Country of origin
principleCommodties <- read.xlsx(tradeStatsFileMergePrincipleCommodities, sheet=1, skipEmptyRows=TRUE)
mergedPrincipleCommodties<- merge(principleCommodties, mergedSITCDescription, by= "HS.Code")

tradeStatsFileMergeBECDescriptions <- file.path("..", "data", "open", "OPN_FINAL_ASY_BECClassifications_31-01-20.xlsx") # Broad economic categories
becDescriptions <- read.xlsx(tradeStatsFileMergeBECDescriptions, sheet=1, skipEmptyRows=TRUE)
mergedBECDescriptions<- merge(becDescriptions, mergedPrincipleCommodties, by= "HS.Code_6")


# New HS codes and SITC codes stored and we are notified


# Create new column header names
newColumnNames<- c("OfficeOfDecleration", "RegistrationReference", "RegistrationDate", "TypeOfDecleration", "CustomsExtendedProcedure", "CustomsNationalProcedure", "BrokerCode", "ItemNumber", "HSCode", "SITCCode", "TradeAgreement", "CommodityDescription", "CommodityMetaData", "CountryOfOrigin", "CountryOfExport/CountryOfDestination", "GrossWeight", "NetWeight", "NumberOfPackages", "PackageType", "SupplementaryQuantity", "SupplementaryUnit", "TermsOfDelivery", "MonetaryValue", "ImportDuty", "ValueAddedTax", "ImportExcise", "DomesticExcise", "ExportDuty", "OtherExportDuty")
colnames(tradeStats)<- newColumnNames
head(tradeStats)

# Processed data set stored
processedTradeStats<- mergedBECDescriptions

```



## Balance of Trade
```{r calculate balance of trade statistics with base R, eval=FALSE, echo=FALSE}

# Calculate the balance of trade statistics - note that this remove a bit of redundancy
exports <- sum(processedTradeStats[processedTradeStats$CP4 == 1000, "Stat..Value"], na.rm=TRUE) # Added na.rm in case NAs introduced at later date
reExports <- sum(processedTradeStats[processedTradeStats$CP4 == 3071, "Stat..Value"], na.rm=TRUE)
totalExports <- exports + reExports
imports <- sum(processedTradeStats[processedTradeStats$CP4 %in% c(4000, 4071, 7100), "Stat..Value"], na.rm=TRUE)
balance <- totalExports - imports

# Insert values into table
tradeBalance <- data.frame("Export"=exports, "Re-Export"=reExports, "Total Export"=totalExports, "Imports CIF"=imports, "Trade Balance"=balance)

prettyTable(tradeBalance)
```

```{r insert balance of trade statistics into final formatted table}

# Extremely helpful resource for openxlsx here: https://rdrr.io/cran/openxlsx/

# Note current year and month of data
fileNameParts <- strsplit(tradeStatsFile, split="_")[[1]]
date <- as.Date(strsplit(fileNameParts[length(fileNameParts)], split="\\.")[[1]][1], format="%d-%m-%y")
month <- format(date, "%B")
year <- format(date, "%Y")

# Note the excel workbook containing the final formmatted tables
finalWorkbookFileName <- file.path("..", "outputs", "SEC_FINAL_MAN_FinalTradeStatisticsTables_31-01-20.xlsx")

## Updating the Annual and Monthly sub tables
# Extract the balance of trade data and extract sub tables
balanceOfTradeSubTables <- extractHistoricBalanceOfTradeStatistics(finalWorkbookFileName)

# Update the sub tables for the balance of trade data
balanceOfTradeSubTables <- updateBalanceOfTradeSubTables(balanceOfTradeSubTables, month, year, tradeBalance/1000000)

## Editing the final formatted tables
updatedFinalFormattedBalanceOfTradeTable(finalWorkbookFileName, balanceOfTradeSubTables)
```


## Import by HS Code
```{r calculate import by HS Code statistics with base R, eval=FALSE, echo=FALSE}

# Calculate the Import by HS Code 
animalProducts <- sum(processedTradeStats[processedTradeStats$CP4 %in% c(4000, 4071, 7100) & processedTradeStats$HS.Code_2 %in% c(01, 02, 03, 04, 05), "Stat..Value"], na.rm=TRUE)

  
  

```

```{r insert Import by HS Code into final formatted table}


```


